<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Jayara Chat — Debug Build</title>

  <!-- styles -->
  <link rel="stylesheet" href="style.css">

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <!-- CryptoJS (AES) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2193b0">

  <style>
    /* small inline-debug hint to ensure debugLog is visible before CSS loads */
    #debugLog{font-size:12px;color:#b71c1c;white-space:pre-wrap;margin-top:8px}
  </style>
</head>
<body>
  <div id="chat" style="max-width:720px;margin:18px auto;padding:12px">
    <h2 style="color:#2193b0;margin:0 0 8px">Jayara Chat</h2>

    <section id="joinPanel" class="card" style="padding:12px;margin-bottom:12px">
      <input id="username" placeholder="Your display name" /><br>
      <input id="room" placeholder="Room name" /><br>
      <input id="passphrase" type="password" placeholder="Room passphrase" /><br>

      <label style="display:block;margin:8px 0">
        Mode:
        <select id="mode">
          <option value="storage">Storage (persist)</option>
          <option value="vanish">Vanish (ephemeral)</option>
        </select>
      </label>

      <div style="display:flex;gap:8px;align-items:center">
        <button onclick="joinRoom()" id="joinBtn" style="padding:10px 14px;background:#317efb;color:#fff;border:none;border-radius:8px;cursor:pointer">Join</button>
        <small style="color:#334">Enter name, room and passphrase</small>
      </div>
    </section>

    <section id="chatPanel" class="card" style="padding:12px;display:none">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div>
          <strong id="roomLabel"></strong>
          <span id="modeBadge" style="margin-left:8px;padding:6px 8px;border-radius:999px;background:#eef6f9;color:#045;display:inline-block"></span>
        </div>
        <div>
          <button onclick="leaveRoom()" id="leaveBtn" style="display:none;padding:8px 12px;border-radius:8px;background:#e67e22;border:none;color:#fff;cursor:pointer">Leave</button>
          <button onclick="clearLocalMessages()" id="deleteBtn" style="display:none;padding:8px 12px;border-radius:8px;background:#e74c3c;border:none;color:#fff;cursor:pointer">Clear Local</button>
        </div>
      </div>

      <div id="messages" style="height:380px;overflow:auto;border:1px solid #eee;padding:10px;border-radius:8px;background:#fff;margin-bottom:8px"></div>

      <div id="composer" style="display:flex;gap:8px">
        <input id="msgBox" placeholder="Type a message..." style="flex:1;padding:10px;border-radius:8px;border:1px solid #d6dbe0" />
        <button onclick="sendMessage()" id="sendBtn" style="padding:10px 14px;background:#2193b0;color:#fff;border:none;border-radius:8px;cursor:pointer">Send</button>
      </div>
    </section>

    <!-- debug log visible in app -->
    <pre id="debugLog" style="background:#fff8f8;border:1px dashed #e6b1b1;padding:8px;border-radius:6px;margin-top:12px;max-height:140px;overflow:auto"></pre>
  </div>

  <!-- main app logic -->
  <script src="apps.js"></script>

  <script>
    // Service worker registration (safe, optional)
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("sw.js").catch(e => {
        const dbg = document.getElementById("debugLog");
        dbg.innerText += "SW register failed: " + (e && e.message ? e.message : String(e)) + "\n";
      });
    }

    // Small runtime sanity checks to help debug missing pieces
    (function sanityChecks(){
      const dbg = document.getElementById("debugLog");
      if (typeof firebase === "undefined") dbg.innerText += "⚠ firebase NOT loaded\n";
      else dbg.innerText += "✅ firebase loaded\n";
      if (typeof CryptoJS === "undefined") dbg.innerText += "⚠ CryptoJS NOT loaded\n";
      else dbg.innerText += "✅ CryptoJS loaded\n";
      // apps.js should define joinRoom; warn if missing
      if (typeof joinRoom !== "function") dbg.innerText += "⚠ joinRoom NOT found (apps.js may not be loaded or contains errors)\n";
      else dbg.innerText += "✅ apps.js loaded\n";
    })();
  </script>
</body>
</html>