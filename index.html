<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jayara - Secure Chat</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4f46e5">
    <link rel="icon" type="image/png" sizes="192x192" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iMjQiIGZpbGw9IiM0ZjQ2ZTUiLz4KPHN2ZyB4PSI0OCIgeT0iNDgiIHdpZHRoPSI5NiIgaGVpZ2h0PSI5NiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJ3aGl0ZSI+CjxwYXRoIGQ9Ik0yMCA0SDRjLTEuMSAwLTIgLjktMiAydjEyYzAgMS4xLjkgMiAyIDJoMTZjMS4xIDAgMi0uOSAyLTJWNmMwLTEuMS0uOS0yLTItMnpNMjAgMTZINHYtNmgxNnY2eiIvPgo8L3N2Zz4KPC9zdmc+">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            color: #333;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        .header {
            background: #4f46e5;
            color: white;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .join-screen {
            padding: 2rem;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 1rem;
        }

        .chat-screen {
            display: none;
            flex-direction: column;
            height: 100vh;
        }

        .chat-header {
            background: #f8fafc;
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .room-info {
            font-size: 0.9rem;
            color: #64748b;
        }

        .mode-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 1rem;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .vanish-mode {
            background: #fef3c7;
            color: #d97706;
        }

        .storage-mode {
            background: #dbeafe;
            color: #2563eb;
        }

        .messages {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .message {
            max-width: 80%;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            word-wrap: break-word;
            animation: slideIn 0.3s ease-out;
            transition: opacity 0.3s ease;
            position: relative;
            overflow-wrap: break-word;
        }

        .message.sent {
            align-self: flex-end;
            background: #4f46e5;
            color: white;
            border-bottom-right-radius: 0.25rem;
        }

        .message.received {
            align-self: flex-start;
            background: #f1f5f9;
            color: #334155;
            border-bottom-left-radius: 0.25rem;
        }

        .message-meta {
            font-size: 0.7rem;
            opacity: 0.7;
            margin-top: 0.25rem;
        }

        .input-area {
            padding: 1rem;
            border-top: 1px solid #e2e8f0;
            background: white;
            display: flex;
            gap: 0.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #374151;
        }

        input, textarea, select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        #messageInput {
            flex: 1;
            border: 2px solid #e5e7eb;
            border-radius: 1rem;
            padding: 0.75rem 1rem;
        }

        button {
            background: #4f46e5;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        button:hover {
            background: #4338ca;
            transform: translateY(-1px);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6b7280;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-danger {
            background: #ef4444;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        #sendButton {
            border-radius: 1rem;
            padding: 0.75rem 1rem;
        }

        .controls {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .controls button {
            font-size: 0.9rem;
            padding: 0.5rem 1rem;
        }

        .debug {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
            max-height: 150px;
            overflow-y: auto;
            font-size: 0.8rem;
            color: #64748b;
        }

        .debug-entry {
            margin-bottom: 0.25rem;
            font-family: 'Courier New', monospace;
        }

        .status {
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            text-align: center;
            font-weight: 600;
        }

        .status.success {
            background: #d1fae5;
            color: #065f46;
        }

        .status.error {
            background: #fee2e2;
            color: #991b1b;
        }

        .status.info {
            background: #dbeafe;
            color: #1e40af;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 640px) {
            .container {
                min-height: 100vh;
            }

            .join-screen {
                padding: 1rem;
            }

            .message {
                max-width: 90%;
            }

            .controls {
                justify-content: center;
            }

            .controls button {
                flex: 1;
                min-width: 120px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üîê Jayara</h1>
            <p>Secure End-to-End Encrypted Chat</p>
        </div>

        <!-- Join Screen -->
        <div class="join-screen" id="joinScreen">
            <div class="form-group">
                <label for="username">Username</label>
                <input type="text" id="username" placeholder="Enter your username" maxlength="20">
            </div>

            <div class="form-group">
                <label for="roomCode">Room Code</label>
                <input type="text" id="roomCode" placeholder="Enter room code" maxlength="20">
            </div>

            <div class="form-group">
                <label for="passphrase">Passphrase (for encryption)</label>
                <input type="password" id="passphrase" placeholder="Enter passphrase">
            </div>

            <div class="form-group">
                <label for="chatMode">Chat Mode</label>
                <select id="chatMode">
                    <option value="vanish">Vanish Mode (24h auto-delete)</option>
                    <option value="storage">Storage Mode (7 days retention)</option>
                </select>
            </div>

            <button id="joinButton">Join Room</button>

            <div class="controls">
                <button id="cleanupButton" class="btn-secondary">üßπ Cleanup Room</button>
            </div>

            <div class="debug" id="debugLog">
                <div class="debug-entry">Ready to join...</div>
            </div>
        </div>

        <!-- Chat Screen -->
        <div class="chat-screen" id="chatScreen">
            <div class="chat-header">
                <div class="room-info">
                    <div id="roomDisplay"></div>
                    <div id="userDisplay"></div>
                </div>
                <div id="modeDisplay"></div>
            </div>

            <div class="messages" id="messages"></div>

            <div class="input-area">
                <input type="text" id="messageInput" placeholder="Type a message..." maxlength="500">
                <button id="sendButton">Send</button>
            </div>

            <div class="controls">
                <button id="leaveButton" class="btn-danger">Leave Room</button>
                <button id="clearLocalButton" class="btn-secondary">Clear Local</button>
                <button id="cleanupRoomButton" class="btn-secondary">üßπ Cleanup</button>
            </div>

            <div class="debug" id="chatDebugLog"></div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-database-compat.min.js"></script>
    
    <!-- CryptoJS for encryption -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB0G0JLoNejrshjLaKxFR264cY11rmhVJU",
            authDomain: "jayara-web.firebaseapp.com",
            databaseURL: "https://jayara-web-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "jayara-web",
            storageBucket: "jayara-web.firebasestorage.app",
            messagingSenderId: "342182893596",
            appId: "1:342182893596:web:664646e95a40e60d0da7d9"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // App state
        let currentUser = '';
        let currentRoom = '';
        let currentPassphrase = '';
        let currentMode = 'vanish';
        let messagesRef = null;
        let isJoined = false;

        // DOM elements
        const joinScreen = document.getElementById('joinScreen');
        const chatScreen = document.getElementById('chatScreen');
        const usernameInput = document.getElementById('username');
        const roomCodeInput = document.getElementById('roomCode');
        const passphraseInput = document.getElementById('passphrase');
        const chatModeSelect = document.getElementById('chatMode');
        const messageInput = document.getElementById('messageInput');
        const messagesDiv = document.getElementById('messages');
        const debugLog = document.getElementById('debugLog');
        const chatDebugLog = document.getElementById('chatDebugLog');
        const roomDisplay = document.getElementById('roomDisplay');
        const userDisplay = document.getElementById('userDisplay');
        const modeDisplay = document.getElementById('modeDisplay');

        // Utility functions
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'debug-entry';
            entry.textContent = `[${timestamp}] ${message}`;
            
            if (isJoined) {
                chatDebugLog.appendChild(entry);
                chatDebugLog.scrollTop = chatDebugLog.scrollHeight;
            } else {
                debugLog.appendChild(entry);
                debugLog.scrollTop = debugLog.scrollHeight;
            }
        }

        function encrypt(text, passphrase) {
            return CryptoJS.AES.encrypt(text, passphrase).toString();
        }

        function decrypt(ciphertext, passphrase) {
            try {
                const bytes = CryptoJS.AES.decrypt(ciphertext, passphrase);
                return bytes.toString(CryptoJS.enc.Utf8);
            } catch (e) {
                return null;
            }
        }

        function generateId() {
            return Date.now().toString() + Math.random().toString(36).substr(2, 9);
        }

        // Load saved data
        function loadSavedData() {
            const savedUser = localStorage.getItem('jayara_username');
            const savedRoom = localStorage.getItem('jayara_room');
            
            if (savedUser) usernameInput.value = savedUser;
            if (savedRoom) roomCodeInput.value = savedRoom;
            
            log('Loaded saved data');
        }

        // Save user data
        function saveUserData() {
            localStorage.setItem('jayara_username', currentUser);
            localStorage.setItem('jayara_room', currentRoom);
        }

        // Message handling
        function addMessage(username, text, timestamp, isOwn = false, messageId) {
            // Check for duplicate messages
            if (document.getElementById(`msg-${messageId}`)) {
                return;
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isOwn ? 'sent' : 'received'}`;
            messageDiv.id = `msg-${messageId}`;
            
            const messageText = document.createElement('div');
            messageText.textContent = text;
            
            const messageMeta = document.createElement('div');
            messageMeta.className = 'message-meta';
            messageMeta.textContent = `${username} ‚Ä¢ ${new Date(timestamp).toLocaleTimeString()}`;
            
            messageDiv.appendChild(messageText);
            messageDiv.appendChild(messageMeta);
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            // Auto-scroll to bottom with smooth behavior
            setTimeout(() => {
                messagesDiv.scrollTo({
                    top: messagesDiv.scrollHeight,
                    behavior: 'smooth'
                });
            }, 100);
        }

        // Send message
        function sendMessage() {
            const text = messageInput.value.trim();
            if (!text || !currentPassphrase) return;

            // Disable send button to prevent double-sending
            const sendButton = document.getElementById('sendButton');
            sendButton.disabled = true;

            const messageId = generateId();
            const timestamp = Date.now();
            const encryptedText = encrypt(text, currentPassphrase);
            
            const messageData = {
                id: messageId,
                username: currentUser,
                text: encryptedText,
                timestamp: timestamp,
                mode: currentMode
            };

            messagesRef.child(messageId).set(messageData)
                .then(() => {
                    messageInput.value = '';
                    log(`Message sent: ${text.substring(0, 20)}${text.length > 20 ? '...' : ''}`);
                })
                .catch(error => {
                    log(`Error sending message: ${error.message}`);
                })
                .finally(() => {
                    sendButton.disabled = false;
                });
        }

        // Cleanup old messages
        async function cleanupRoom() {
            if (!currentRoom) return;
            
            log('Starting room cleanup...');
            
            try {
                const snapshot = await messagesRef.once('value');
                const messages = snapshot.val() || {};
                const now = Date.now();
                const deletions = [];

                Object.keys(messages).forEach(key => {
                    const message = messages[key];
                    const age = now - message.timestamp;
                    
                    // Delete vanish mode messages older than 24h
                    if (message.mode === 'vanish' && age > 24 * 60 * 60 * 1000) {
                        deletions.push(messagesRef.child(key).remove());
                    }
                    // Delete storage mode messages older than 7 days
                    else if (message.mode === 'storage' && age > 7 * 24 * 60 * 60 * 1000) {
                        deletions.push(messagesRef.child(key).remove());
                    }
                });

                await Promise.all(deletions);
                log(`Cleanup complete: ${deletions.length} messages removed`);
                
            } catch (error) {
                log(`Cleanup error: ${error.message}`);
            }
        }

        // Join room
        async function joinRoom() {
            const username = usernameInput.value.trim();
            const roomCode = roomCodeInput.value.trim();
            const passphrase = passphraseInput.value.trim();
            const mode = chatModeSelect.value;

            if (!username || !roomCode || !passphrase) {
                log('Please fill all fields');
                return;
            }

            currentUser = username;
            currentRoom = roomCode;
            currentPassphrase = passphrase;
            currentMode = mode;
            
            log(`Joining room ${roomCode} as ${username} in ${mode} mode...`);
            
            // Setup Firebase reference
            messagesRef = database.ref(`rooms/${roomCode}/messages`);
            connectionRef = database.ref('.info/connected');
            
            // Listen for messages
            messagesRef.on('child_added', (snapshot) => {
                const message = snapshot.val();
                if (!message) return;

                const decryptedText = decrypt(message.text, currentPassphrase);
                if (decryptedText) {
                    const isOwn = message.username === currentUser;
                    addMessage(message.username, decryptedText, message.timestamp, isOwn, message.id);
                } else {
                    log('Failed to decrypt message (wrong passphrase?)');
                }
            });

            // Listen for messages being removed (for real-time cleanup)
            messagesRef.on('child_removed', (snapshot) => {
                const messageId = snapshot.key;
                const messageElement = document.getElementById(`msg-${messageId}`);
                if (messageElement) {
                    messageElement.style.opacity = '0';
                    setTimeout(() => messageElement.remove(), 300);
                }
            });

            // Monitor connection status
            updateConnectionStatus();

            // Update UI
            roomDisplay.textContent = `Room: ${roomCode}`;
            userDisplay.textContent = `User: ${username}`;
            modeDisplay.innerHTML = `<div class="mode-badge ${mode}-mode">${mode.toUpperCase()}</div>`;
            
            // Save data and switch screens
            saveUserData();
            isJoined = true;
            joinScreen.style.display = 'none';
            chatScreen.style.display = 'flex';
            
            messageInput.focus();
            log('Successfully joined room');
            
            // Auto-cleanup on join
            setTimeout(cleanupRoom, 1000);
        }

        // Leave room
        function leaveRoom() {
            if (messagesRef) {
                messagesRef.off();
                messagesRef = null;
            }
            
            // Clear all state
            currentUser = '';
            currentRoom = '';
            currentPassphrase = '';
            isJoined = false;
            
            // Clear UI
            messagesDiv.innerHTML = '';
            chatDebugLog.innerHTML = '<div class="debug-entry">Left room successfully</div>';
            
            // Reset form
            passphraseInput.value = '';
            
            joinScreen.style.display = 'flex';
            chatScreen.style.display = 'none';
            
            log('Left room and cleared all data');
        }

        // Clear local messages
        function clearLocal() {
            messagesDiv.innerHTML = '';
            log('Local messages cleared');
        }

        // Event listeners
        document.getElementById('joinButton').addEventListener('click', joinRoom);
        document.getElementById('sendButton').addEventListener('click', sendMessage);
        document.getElementById('leaveButton').addEventListener('click', leaveRoom);
        document.getElementById('clearLocalButton').addEventListener('click', clearLocal);
        document.getElementById('cleanupButton').addEventListener('click', cleanupRoom);
        document.getElementById('cleanupRoomButton').addEventListener('click', cleanupRoom);

        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Auto-cleanup interval (every 10 minutes)
        setInterval(() => {
            if (isJoined) {
                cleanupRoom();
            }
        }, 10 * 60 * 1000);

        // Connection status monitoring
        let isOnline = navigator.onLine;
        let connectionRef = null;

        function updateConnectionStatus() {
            if (isJoined && connectionRef) {
                connectionRef.on('value', (snapshot) => {
                    const connected = snapshot.val();
                    if (connected) {
                        log('‚úÖ Connected to Firebase');
                    } else {
                        log('‚ùå Disconnected from Firebase');
                    }
                });
            }
        }

        window.addEventListener('online', () => {
            isOnline = true;
            log('üì∂ Back online');
            updateConnectionStatus();
        });

        window.addEventListener('offline', () => {
            isOnline = false;
            log('üìµ Offline mode');
        });

        // Initialize app
        loadSavedData();
        log('Jayara initialized - Ready to join a room');

        // Register service worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        log('SW registered successfully');
                    })
                    .catch((error) => {
                        log('SW registration failed');
                    });
            });
        }
    </script>

    <!-- Manifest and SW scripts need to be separate files -->
    <script>
        // Create manifest.json dynamically
        const manifest = {
            "name": "Jayara - Secure Chat",
            "short_name": "Jayara",
            "description": "End-to-end encrypted chat application",
            "start_url": "/",
            "display": "standalone",
            "background_color": "#ffffff",
            "theme_color": "#4f46e5",
            "icons": [
                {
                    "src": "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iMjQiIGZpbGw9IiM0ZjQ2ZTUiLz4KPHN2ZyB4PSI0OCIgeT0iNDgiIHdpZHRoPSI5NiIgaGVpZ2h0PSI5NiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJ3aGl0ZSI+CjxwYXRoIGQ9Ik0yMCA0SDRjLTEuMSAwLTIgLjktMiAydjEyYzAgMS4xLjkgMiAyIDJoMTZjMS4xIDAgMi0uOSAyLTJWNmMwLTEuMS0uOS0yLTItMnpNMjAgMTZINHYtNmgxNnY2eiIvPgo8L3N2Zz4KPC9zdmc+",
                    "sizes": "192x192",
                    "type": "image/svg+xml"
                }
            ]
        };

        // Create a blob URL for the manifest
        const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
        const manifestURL = URL.createObjectURL(manifestBlob);
        document.querySelector('link[rel="manifest"]').href = manifestURL;
    </script>
</body>
</html>